---
title: "ang-boxplot"
author: "Angeliki"
date: '2022-04-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Effect-of-treatment boxplots

CD3D, MS4A1, CTLA4, CD19 -> where shown to go back to normal
after treatment
IL10, CLEC12A, AURKA, MMP13, CLEC2B, CD58 -> are RA markers
and do not return to normal levels

libraries
```{r}
library(tidyverse)
```

## Load data
```{r}
# logfold_treatment <- read_tsv(
#   file = "../data/03_treatment_log2fc.tsv")
treatment_dataset <- read_tsv(
  file = "../data/02_treatment_w_meta_clean.tsv")
all_conditions <- read_tsv(
  file = "../data/02_large_w_meta_clean.tsv")
```

Wrangle

<!-- This are the wrong logs -->
<!-- From the logfolds select only important genes and make it  -->
<!-- into long format. -->

```{r}
# logFC_treatment <- logfold_treatment %>% 
#   select(id,
#          CD3D,
#          MS4A1,
#          CTLA4,
#          CD19,
#          IL10,
#          CLEC12A,
#          AURKA,
#          MMP13,
#          CLEC2B,
#          CD58
#          ) %>% 
#   pivot_longer(cols = -c(id),
#                names_to = "Genes" , 
#                values_to = "log2fc")
# 
# logFC_treatment
```

From the all_conditions select only normal tissues and
the important genes.


```{r}
healthy <- 
  all_conditions %>% 
  filter(disease == "Normal") %>% 
  select(id,
         CD3D,
         MS4A1,
         CTLA4,
         CD19,
         IL10,
         CLEC12A,
         AURKA,
         MMP13,
         CLEC2B,
         CD58
         )
```

## Prepare healthy


For the healthy, calculate mean expression level
of each gene and do a logfold by this mean

### Calculate mean 
```{r}
# transpose and add mean 
healthy_dataset <- healthy %>%  
  pivot_longer(cols = -id, 
               names_to = "Genes",
               values_to = "Reads") %>% 
  pivot_wider(names_from = id,
              values_from = Reads) %>% 
  mutate(mean_expression =
           rowMeans(across(
             where(is.numeric)
           )
           )
  ) 

healthy_dataset
```

## Prepare baseline RA (RA_pre)


```{r}
pre_dataset <- treatment_dataset %>% 
  select(id,
         CD3D,
         MS4A1,
         CTLA4,
         CD19,
         IL10,
         CLEC12A,
         AURKA,
         MMP13,
         CLEC2B,
         CD58
         )  %>%
  filter(grepl("RA_pre", id)) %>%
  pivot_longer(cols = -c(id),
               names_to = "Genes" ,
               values_to = "Reads") %>% 
  pivot_wider(names_from = id, values_from = Reads)

pre_dataset
```

## Prepare post- tDMARD RA (RA_post)


```{r}
post_dataset <- treatment_dataset %>% 
  select(id,
         CD3D,
         MS4A1,
         CTLA4,
         CD19,
         IL10,
         CLEC12A,
         AURKA,
         MMP13,
         CLEC2B,
         CD58
         )  %>%
  filter(grepl("RA_post", id)) %>%
  pivot_longer(cols = -c(id),
               names_to = "Genes" ,
               values_to = "Reads") %>% 
  pivot_wider(names_from = id, values_from = Reads) 

post_dataset
```

## Join all

```{r}
all_dataset <-pre_dataset %>% 
  full_join(post_dataset, by = "Genes") %>% 
  full_join(healthy_dataset, by = "Genes")
```
## Calculate fold change

**FC = Post t-DMARD RA/Normal_mean**

**FC = Baseline RA/Normal_mean**

**FC = Normal/Normal_mean**

<span style="color: red;">*Currently stuck here, how to add a condition variable depended on id*</span>
```{r}
# calculate logFC
only_logFCs <- all_dataset %>% 
  transmute(
    across(
      !c(Genes, mean_expression),
    ~ log2(. + 1) - log2(mean_expression + 1)
    )
  )

# now combine the above, make it long and add condition variable
all_logfc <-
  all_dataset %>% 
  select(Genes) %>% 
  bind_cols(only_logFCs) %>% 
  pivot_longer(cols = -Genes,
               names_to = "id",
               values_to = "logFC")

# all_logfc%>% 
#   select(id =starts_with("RA_pre")) %>% 
#   mutate(condition = "RA t-DMARD")
  



all_logfc
```


## From Javi!!
```{r}
selected_logfold <-
  all_logfold %>% 
  filter( 
      Genes == "CD3D" 
    | Genes == "MS4A1"
    | Genes == "CTLA4"
    | Genes == "CD19"
    | Genes == "IL10"
    | Genes == "CLEC12A"
    | Genes == "AURKA"
    | Genes == "MMP13"
    | Genes == "CLEC2B"
    | Genes == "CD58")

selected_logfold

```



Visualize
```{r}
# all_log %>% 
#   ggplot(mapping = aes(
#     x = 
#   ))
#   
```

